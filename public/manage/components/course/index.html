<link rel="stylesheet" href="assets/module/formSelects/formSelects-v4.css"/>
<style>
    .layui-table-cell{height: auto;}
</style>
<!-- 正文开始 -->
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-body" id="layPhotosTbImg">
            <div class="layui-form toolbar">
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <input id="userEdtSearch" class="layui-input" type="text" placeholder="课程名称"/>
                    </div>
                    <div class="layui-inline">
                        <select id="category_id">
                            <option value="">课程分类</option>
                        </select>
                    </div>
                    <div class="layui-inline">
                        <select name="status" id="status">
                            <option value="">状态</option>
                            <option value="1">上架</option>
                            <option value="0">下架</option>
                        </select>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">上架时间</label>
                        <div class="layui-input-inline">
                            <input type="text" name="date" id="date" lay-verify="date" placeholder="yyyy-MM-dd" autocomplete="off" class="layui-input">
                        </div>
                        <div class="layui-input-inline">
                            <input type="text" name="date2" id="date2" lay-verify="date2" placeholder="yyyy-MM-dd" autocomplete="off" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <button id="companyBtnSearch" class="layui-btn icon-btn"><i class="layui-icon">&#xe615;</i>搜索
                        </button>
                        <button id="companyBtnAdd" class="layui-btn icon-btn"><i class="layui-icon">&#xe654;</i>添加</button>
                    </div>
                </div>
            </div>

            <table class="layui-table" id="userTable" lay-filter="userTable"></table>
        </div>
    </div>
</div>

<!-- 表格操作列 -->
<script type="text/html" id="userTableBar">
    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="edit">修改</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>

<!-- 表单弹窗 -->
<script type="text/html" id="modelUser">
    <div class="layui-tab">
        <div class="layui-tab-content">
                <form id="modelUserForm" lay-filter="modelUserForm" class="layui-form model-form">
                    <input name="id" type="hidden"/>
                    <div class="layui-form-item">
                        <label class="layui-form-label"><span style="color: red;">*</span>课程名称</label>
                        <div class="layui-input-block">
                            <input type="text" name="title" placeholder="请输入商品名称,最多40个字" value="" lay-verType="tips" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item buyway1_show">
                        <label class="layui-form-label">课程副标题</label>
                        <div class="layui-input-block">
                            <input type="text" name="subtitle" placeholder="请输入商品副标题,最多20个字" value=""
                                   class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label"><span style="color: red;">*</span>课程类目</label>
                        <div class="layui-input-block">
                            <select name="category_id" xm-select="category_id" lay-verType="tips" lay-verify="required">
                                <option value="">请选择信息分类</option>
                            </select>
                        </div>
                    </div>


                    <div class="layui-form-item">
                        <label class="layui-form-label"><span style="color: red;">*</span>商品封面图</label>
                        <div class="layui-input-inline upfile_btn">
                            <button type="button" class="layui-btn upfile_btn" id="upload_image"><i class="layui-icon">&#xe67c;</i>上传图片</button>
                        </div>
                        <div class="layui-input-inline">
                            <div class="img_tip_content">最大尺寸：300像素 * 300像素，图片大小不得超过80K</div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">预览图</label>
                        <div class="layui-input-block">
                            <div class="layui-upload-list layui-upload-imgs" >
                                <img class="layui-upload-img" style="width: 92px;height: 92px" id="layui-upload-imgs">
                                <i class="layui-icon layui-icon-close-fill" style="display: none"></i>
                                <input type="hidden" name="coverImgUrl">
                                <input type="hidden" name="thumb">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">轮播图</label>
                        <div class="layui-input-inline">
                            <input type="text" name="thumbs" required lay-verify="required" placeholder="图片地址"  class="layui-input">
                        </div>
                        <div class="layui-input-inline upfile_btn">
                            <button type="button" class="layui-btn layui-input-inline upfile_btn" autocomplete="off" id="upload_thumbs_image"><i class="layui-icon">&#xe67c;</i>上传图片</button>
                        </div>
                        <div class="layui-input-inline">
                            <div class="img_tip_content">图片宽度：400px；图片高度：400px；</div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">预览图</label>
                        <div class="layui-input-block">
                            <div class="layui-upload-list layui-upload-imgs" id="layui-upload-thumbs">
                                <ul>

                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <label class="layui-form-label">视频</label>
                        <div class="layui-input-inline">
                            <input type="hidden" name="video_url" class="layui-input">
                        </div>
                        <div class="layui-input-inline upfile_btn">
                            <button type="button" class="layui-btn upfile_btn" id="upload_video"><i class="layui-icon">&#xe67c;</i>上传视频</button>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">预览图</label>
                        <div class="layui-input-block">
                            <div class="layui-upload-list layui-upload-imgs" id="layui-upload-videos">
                                <ul>

                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label"><span style="color: red;">*</span>课程价格</label>
                        <div class="layui-input-block">
                            <input type="number" name="price" placeholder="0.00" value="" class="layui-input">
                        </div>
                    </div>

                    <div class="layui-form-item buyway1_show">
                        <label class="layui-form-label">虚拟销量</label>
                        <div class="layui-input-block">
                            <input type="number" name="ficti_num" placeholder="0" value="" class="layui-input">
                            <div class="form-text m-b-none"> （前台展示销量=虚拟销量加真实销量）
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item buyway1_show">
                        <label class="layui-form-label"><span style="color: red;">*</span>快递运费</label>
                        <div class="layui-input-block">
                            <input type="number" name="expressprice" placeholder="0.00" value=""
                                   class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">课程状态</label>
                        <div class="layui-input-block">
                            <input type="radio" name="status" value="1" title="上架" checked>
                            <input type="radio" name="status" value="0" title="下架" >
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">商品描述</label>
                        <div class="layui-input-block">
                            <textarea id="content" name="description" ></textarea>
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <label class="layui-form-label">商品排序</label>
                        <div class="layui-input-block">
                            <input type="number" name="sort" placeholder="0" value="" class="layui-input">
                            <div class="form-text m-b-none"> （排序数字越大，商品在购买页展示顺序越前）
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item text-right">
                        <button class="layui-btn layui-btn-primary" type="button" ew-event="closeDialog">取消</button>
                        <button id="btnSave" class="layui-btn" lay-filter="modelAuthSubmit" lay-submit>提交保存</button>
                    </div>
                </form>

        </div>
    </div>

</script>
<script>
    layui.use(['layer', 'table', 'form', 'layedit', 'config','treetable', 'admin', 'alioss','element','uploadst','laydate'], function () {
        var $ = layui.jquery;
        var layer = layui.layer;
        var table = layui.table;
        var laydate = layui.laydate;
        var form = layui.form;
        var layedit = layui.layedit;
        var config = layui.config;
        var admin = layui.admin;
        var uploadst = layui.uploadst;
        var alioss = layui.alioss;
        var category = "";

        // 渲染laydate
        //日期
        laydate.render({
            elem: '#date'
            ,type: 'datetime'
            ,format: 'yyyy-MM-dd HH:mm:ss'
        });
        laydate.render({
            elem: '#date2'
            ,type: 'datetime'
            ,format: 'yyyy-MM-dd HH:mm:ss'
        });

        admin.req('coursecategory/list', {}, function (res) {
            category = res.data.menus;
            $('#category_id').append(category);
        }, 'post');

        var insTb = table.render({
            url: config.base_server + 'course/list',
            method: 'post',
            treeColIndex: 1,
            treeSpid: 0,
            headers: {
                'Authorization': 'Bearer ' + config.getToken().access_token
            },
            elem: '#userTable',
            cellMinWidth: 100,
            page: true,
            cols: [[
                {type: 'numbers',width: 100, title: '课程ID'},
                {field: 'title', title: '课程名称'},
                {
                    title: '封面图', width: 300, align: 'center', templet: function (d) {
                        var str = "";
                        if(d.oss_image != ""){
                            str =  '<img src="'+ d.oss_image +'" class="table_img">'
                        }

                        return str;
                    }
                },
                {field: 'price', title: '购买价格'},
                {field: 'expressprice', title: '运费'},
                {field: 'sale_num', title: '总销量'},
                {field: 'sort', title: '排序号', align: 'center'},
                {field: 'stateon', title: '上架时间' ,align: 'center',},
                {
                    title: '显示状态', width: 100, templet: function (d) {
                        var str = "-";
                        if(d.status == 0)
                            str = "下架";
                        else if(d.status == 1)
                            str = "上架";
                        return str;
                    }, align: 'center'
                },
                {templet: '#userTableBar', title: '操作', align: 'center', minWidth: 100}
            ]],
            done: function(res, curr, count){
                if(!admin.hasPerm('course:save')){
                    $("a[lay-event='edit']").remove();
                }
                if(!admin.hasPerm('course:delete')){
                    $("a[lay-event='del']").remove();
                }
                $('.table_img').on('click', function () {
                    var img = $(this).attr('src');
                    layer.photos({
                        photos: { "data": [{"src": img}]}
                        ,anim: 5 //0-6的选择，指定弹出图片动画类型，默认随机
                    });
                })
            }
        });

        setTimeout(function(){
            form.render('select');
        }, 1000);

        // 搜索按钮点击事件
        $('#companyBtnSearch').click(function () {
            var value = $('#userEdtSearch').val();
            var category_id = $('#category_id').val();
            var status = $('#status').val();
            var data = $('#date').val();
            var data2 = $('#date2').val();
            insTb.reload({where: {title: value,category_id:category_id,status:status,start_at:data,end_at:data2}});
        });

        // 添加按钮点击事件
        if(!admin.hasPerm('course:save')){
            $("#companyBtnAdd").remove();
        }
        else
        {
            $('#companyBtnAdd').click(function () {
                showEditModel();
            });
        }


        // 工具条点击事件
        table.on('tool(userTable)', function (obj) {
            var data = obj.data;
            var layEvent = obj.event;

            if (layEvent === 'edit') { // 修改
                showEditModel(data);
            } else if (layEvent === 'del') {  // 删除
                layer.confirm('确定要删除吗？', {
                    skin: 'layui-layer-admin'
                }, function (i) {
                    layer.close(i);
                    layer.load(2);
                    admin.req('course/delete', {
                        id: data.id
                    }, function (res) {
                        layer.closeAll('loading');
                        if (res.code == 200) {
                            layer.msg(res.msg, {icon: 1});
                            insTb.reload();
                        } else {
                            layer.msg(res.msg, {icon: 2});
                        }
                    }, 'post');
                });
            }
        });

        // 显示表单弹窗
        function showEditModel(data) {
            admin.open({
                type: 1,
                title: (data ? '修改' : '添加') + '课程',
                area: ['1200px', '820px'],
                content: $('#modelUser').html(),
                success: function (layero, dIndex) {
                    if(!admin.hasPerm('course:save') && !admin.hasPerm('course:update')){
                        $("#btnSave").remove();
                    }
                    alioss.vals = '';
                    $("select[name='category_id']").append(category);
                    var url = data ? 'course/update' : 'course/save';
                    var videos ='';
                    var thumbs ='';
                    if(data){
                        // 回显数据

                        if(data.oss_image != "") {
                            // $("#layui-upload-imgs ul").append('<li><img src="'+ data.oss_image +'" data-path="'+data.thumb +'"><i class="layui-icon layui-icon-close-fill"></i></li>');
                            $('#layui-upload-imgs').attr('src',data.oss_image);
                        }
                        if(data.oss_images.length>0) {

                            thumbs = data.thumbs;
                            $.each(data.oss_images,function (i,e) {
                                $("#layui-upload-thumbs ul").append('<li><img src="'+ e +'" data-path="'+data.oss_images_d[i] +'"><i class="layui-icon layui-icon-close-fill"></i></li>');
                            })
                            alioss.vals=thumbs+',';
                        }
                        if(data.oss_videos){
                            videos = data.video_url;
                            $.each(data.oss_videos,function (i,e) {
                                var file_name=e.replace(/(.*\/)*([^.]+).*/ig,"$2");
                                $("#layui-upload-videos ul").append('<li><img  data-path="'+e +'"><i class="layui-icon layui-icon-close-fill"></i><span ">'+file_name+'</span></li>');
                            })
                            alioss.videos=videos+',';
                        }

                        $("input[name='name']").val([data.name]);
                        $("input[name='subtitle']").val([data.subtitle]);
                        $("input[name='thumbs']").val([data.thumbs]);
                        $("input[name='unit']").val([data.unit]);
                        $("input[name='keyword']").val([data.keyword]);
                        $("input[name='productprice']").val([data.productprice]);
                        $("input[name='marketprice']").val([data.marketprice]);
                        $("input[name='ficti_num']").val([data.ficti_num]);
                        $("input[name='description']").val([data.description]);
                        $("input[name='stock']").val([data.stock])
                        // $("#layui-upload-logo-img").attr('src',[data.thumbs])
                        if ( data.status == '0') {
                            $('input[name="status"][value="0"]').prop("checked", true);
                        }

                        form.val('modelUserForm', data);
                    }else{
                        form.render('radio');
                        form.render('select');
                    }
                    layedit.set({
                        uploadImage: {
                            url: config.base_server + 'uploade/image?token=' + config.getToken().access_token//接口url
                            ,type: '' //默认post
                        }
                    });
                    var editIndex = layedit.build('content', {height: 200});

                    //主图
                    // var option = {
                    //     previewEle: "#layui-upload-imgs ul",
                    //     elem: "#upload_image",
                    //     dataType: "xml",
                    //     accept: "images",
                    //     acceptMime: "image/*",
                    //     auto: false,
                    //     multiple: true,
                    //     number:1
                    // };
                    var options = {
                        elem: "#upload_image",
                        previewEle: "#layui-upload-imgs",
                        url:config.base_server+'uploade/wechatGoodsImage'
                    };
                    uploadst.uploadGoodsWechatImg(options);

                    //轮播图
                    var option2 = {
                        previewEle: "#layui-upload-thumbs ul",
                        elem: "#upload_thumbs_image",
                    };
                    alioss.initUpload(option2);


                    //视频
                    var videoOption = {
                        number: 1,
                    };
                    alioss.initVideoUpload(videoOption);

                    // 表单提交事件
                    form.on('submit(modelAuthSubmit)', function (data) {
                        var editValue = layedit.getContent(editIndex);console.log(editValue);
                        data.field.description = editValue;
                        admin.req(url, data.field, function (res) {
                            layer.closeAll('loading');
                            if (res.code == 200) {
                                layer.close(dIndex);
                                layer.msg(res.msg, {icon: 1});
                                insTb.reload();
                            } else {
                                layer.msg(res.msg, {icon: 2});
                            }
                        }, 'post');
                        return false;
                    });

                }
            });
        };
    });
</script>